<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risky - Rediger analyse</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/heatmap.css">
    <link rel="stylesheet" href="css/table.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/comments.css">

    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- ZIP Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="editor-header">
            <button id="backBtn" class="btn btn-secondary">‚Üê Tilbake til oversikt</button>
            <span id="savedIndicator" class="saved-indicator">Lagret ‚úì</span>
        </div>

        <!-- Metadata seksjon -->
        <section class="metadata-section">
            <h1 contenteditable="true" id="analysisName">Ny analyse</h1>

            <div class="form-grid">
                <div class="form-group">
                    <label for="dato">Dato (√Ö√Ö√Ö√Ö-MM-DD):</label>
                    <input type="text" id="dato" class="form-control" placeholder="2026-02-26" pattern="\d{4}-\d{2}-\d{2}">
                </div>

                <div class="form-group">
                    <label for="tjeneste">Tjeneste/system:</label>
                    <input type="text" id="tjeneste" class="form-control">
                </div>

                <div class="form-group">
                    <label for="utfortAv">Utf√∏rt av:</label>
                    <input type="text" id="utfortAv" class="form-control">
                </div>

                <div class="form-group">
                    <label for="deltakere">Deltakere:</label>
                    <input type="text" id="deltakere" class="form-control">
                </div>

                <div class="form-group">
                    <label for="tjenesteeier">Tjenesteeier/systemeier:</label>
                    <input type="text" id="tjenesteeier" class="form-control">
                </div>

                <div class="form-group full-width">
                    <label for="beskrivelse">Beskrivelse:</label>
                    <textarea id="beskrivelse" class="form-control" rows="3"></textarea>
                </div>
            </div>
        </section>

        <!-- Heatmap seksjon -->
        <section class="heatmap-section sticky-heatmap">
            <h2>RISIKO HEATMAP</h2>
            <canvas id="heatmapCanvas" width="600" height="500"></canvas>
            <div class="heatmap-legend">
                <span class="legend-item"><span class="legend-color" style="background:#28a745"></span>Gr√∏nn (1-6)</span>
                <span class="legend-item"><span class="legend-color" style="background:#ffc107"></span>Gul (7-12)</span>
                <span class="legend-item"><span class="legend-color" style="background:#fd7e14"></span>Oransje (13-18)</span>
                <span class="legend-item"><span class="legend-color" style="background:#dc3545"></span>R√∏d (19-25)</span>
            </div>
        </section>

        <!-- Statistikk seksjon -->
        <section class="stats-section">
            <h2>STATISTIKK</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">Totalt antall risikoer</div>
                </div>
                <div class="stat-card stat-red">
                    <div class="stat-value" id="statRed">0</div>
                    <div class="stat-label">R√∏de risikoer (19-25)</div>
                    <div class="stat-percent" id="statRedPercent">0%</div>
                </div>
                <div class="stat-card stat-orange">
                    <div class="stat-value" id="statOrange">0</div>
                    <div class="stat-label">Oransje risikoer (13-18)</div>
                    <div class="stat-percent" id="statOrangePercent">0%</div>
                </div>
                <div class="stat-card stat-yellow">
                    <div class="stat-value" id="statYellow">0</div>
                    <div class="stat-label">Gule risikoer (7-12)</div>
                    <div class="stat-percent" id="statYellowPercent">0%</div>
                </div>
                <div class="stat-card stat-green">
                    <div class="stat-value" id="statGreen">0</div>
                    <div class="stat-label">Gr√∏nne risikoer (1-6)</div>
                    <div class="stat-percent" id="statGreenPercent">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvgRisk">0.0</div>
                    <div class="stat-label">Gjennomsnittlig risikoniv√•</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-box">
                    <h3>Fordeling etter konsekvens</h3>
                    <canvas id="consequenceChart" width="300" height="200"></canvas>
                </div>
                <div class="chart-box">
                    <h3>Fordeling etter sannsynlighet</h3>
                    <canvas id="probabilityChart" width="300" height="200"></canvas>
                </div>
                <div class="chart-box">
                    <h3>KIT-analyse fordeling</h3>
                    <canvas id="kitChart" width="300" height="200"></canvas>
                </div>
            </div>
        </section>

        <!-- Risikotabell -->
        <section class="risks-section">
            <h2>RISIKOER</h2>

            <div class="table-container">
                <table id="risksTable" class="risks-table">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Risikoelement</th>
                            <th>S√•rbarhet/svakhet</th>
                            <th>Eksisterende beskyttelse</th>
                            <th>Eksisterende kontroll</th>
                            <th>K</th>
                            <th>I</th>
                            <th>T</th>
                            <th>K*</th>
                            <th>S*</th>
                            <th>RN*</th>
                            <th>Foresl√•tte tiltak</th>
                            <th>Handlinger</th>
                        </tr>
                    </thead>
                    <tbody id="risksTableBody">
                        <!-- Risikoer vil bli lagt til her -->
                    </tbody>
                </table>
            </div>

            <div class="add-risk-container">
                <button id="addRiskBtn" class="btn btn-primary">+ Legg til risiko</button>
                <button id="importRisksBtn" class="btn btn-secondary">üì• Importer risikoer fra analyse</button>
            </div>
        </section>

        <!-- KIT-analyse -->
        <section class="kit-section">
            <h2>KIT-ANALYSE (Konfidensialitet, Integritet, Tilgjengelighet)</h2>
            <table class="kit-table">
                <thead>
                    <tr>
                        <th>Kombinasjon</th>
                        <th>Antall risikoer</th>
                    </tr>
                </thead>
                <tbody id="kitTableBody">
                    <!-- KIT-data vil bli lagt til her -->
                </tbody>
            </table>
        </section>

        <!-- Egendefinert tekstseksjon -->
        <section class="custom-text-section">
            <h2 contenteditable="true" id="customTextTitle" class="editable-title">TILLEGGSINFORMASJON</h2>
            <div class="form-group">
                <textarea id="customText" class="form-control custom-text-area" rows="8" placeholder="Skriv inn tilleggsinformasjon som skal inkluderes i rapporten..."></textarea>
            </div>
            <small class="text-muted">Overskriften og teksten over blir med i PDF- og Excel-rapporter.</small>
        </section>

        <!-- Tiltak og kommentarer -->
        <section id="commentsSection" class="comments-section">
            <div class="comments-section-header">
                <h2 contenteditable="true" id="commentsSectionTitle" class="editable-title">TILTAK OG KOMMENTARER</h2>
                <div class="comments-toggle-buttons">
                    <button id="toggleTiltakBtn" class="btn-toggle-type active" onclick="toggleCommentType('tiltak')">Skjul tiltak</button>
                    <button id="toggleKommentarBtn" class="btn-toggle-type active" onclick="toggleCommentType('kommentar')">Skjul kommentarer</button>
                    <button id="toggleOppfolgingBtn" class="btn-toggle-type active" onclick="toggleCommentType('oppfolging')">Skjul oppf√∏lging</button>
                    <button id="toggleInternBtn" class="btn-toggle-type active" onclick="toggleCommentType('intern')">Skjul intern</button>
                </div>
            </div>
            <div id="commentsContent" class="comments-content">
                <!-- Kommentarer vil bli lagt til her -->
            </div>
        </section>

        <!-- Eksport -->
        <section class="export-section">
            <h2>EKSPORT</h2>
            <div class="export-buttons">
                <button id="exportPdfBtn" class="btn btn-primary">üìÑ Eksporter PDF</button>
                <button id="exportExcelBtn" class="btn btn-primary">üìä Eksporter Excel</button>
                <button id="exportJsonBtn" class="btn btn-primary">üíæ Eksporter JSON</button>
                <button id="exportAllBtn" class="btn btn-primary btn-highlight">üì¶ Eksporter alt (ZIP)</button>
            </div>

            <div class="acceptance-level-section">
                <h3>Akseptanseniv√• og risikorapport</h3>
                <div class="acceptance-level-controls">
                    <div class="form-group">
                        <label for="acceptanceLevel">Akseptanseniv√• (risikoer over dette niv√•et vil bli eksportert):</label>
                        <select id="acceptanceLevel" class="form-control" style="max-width: 200px;">
                            <option value="0">0 - Ingen</option>
                            <option value="6">6 - Gr√∏nn (lav)</option>
                            <option value="12" selected>12 - Gul (medium)</option>
                            <option value="18">18 - Oransje (h√∏y)</option>
                            <option value="19">19 - R√∏d (kritisk)</option>
                        </select>
                    </div>
                    <div class="export-preview">
                        <span id="acceptanceLevelPreview">0 risikoer over niv√• 12</span>
                    </div>
                    <button id="exportMarkdownBtn" class="btn btn-primary">üìù Eksporter h√∏yrisikorappport (Markdown)</button>
                </div>
            </div>
        </section>

        <!-- Risikobank administrasjon -->
        <section class="bank-admin-section">
            <h2>RISIKOBANK ADMINISTRASJON</h2>
            <p class="section-description">Last opp egne risikobanker i JSON-format. Disse vil v√¶re tilgjengelige n√•r du legger til nye risikoer.</p>

            <div class="bank-upload">
                <input type="file" id="bankFileInput" accept=".json" style="display: none;">
                <button id="uploadBankBtn" class="btn btn-primary">üìÅ Last opp risikobank</button>
                <span id="uploadStatus" class="upload-status"></span>
            </div>

            <div id="customBanksList" class="custom-banks-list">
                <!-- Custom banker vil bli vist her -->
            </div>
        </section>
    </div>

    <!-- Risikobank Modal -->
    <div id="risikobankModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Velg fra risikobank</h2>
                <button class="modal-close" onclick="closeRisikobankModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="bankSelector" class="bank-selector"></div>
                <div id="kategoriSelector" class="kategori-selector"></div>
                <div id="risikoListe" class="risiko-liste"></div>
            </div>
        </div>
    </div>

    <!-- Kommentar Modal -->
    <div id="commentModal" class="comment-modal">
        <div class="comment-modal-content">
            <div class="comment-modal-header">
                <h3>Legg til tiltak/kommentar</h3>
                <button class="modal-close" onclick="closeCommentModal()">√ó</button>
            </div>
            <div class="comment-modal-body">
                <div class="comment-form">
                    <div class="comment-form-group">
                        <label for="commentType">Type:</label>
                        <select id="commentType">
                            <option value="tiltak">Tiltak</option>
                            <option value="kommentar">Kommentar</option>
                            <option value="oppfolging">Oppf√∏lging</option>
                            <option value="intern">Intern kommentar</option>
                        </select>
                    </div>

                    <div class="comment-form-group">
                        <label for="commentText">Beskrivelse:</label>
                        <textarea id="commentText" placeholder="Beskriv tiltaket eller kommentaren..."></textarea>
                    </div>

                    <div class="comment-form-group">
                        <label>Eksterne lenker (valgfritt):</label>
                        <div id="commentLinksContainer"></div>
                        <button type="button" class="btn-add-link" onclick="addLinkField()">+ Legg til lenke</button>
                    </div>

                    <button type="button" class="btn-save-comment" onclick="saveComment()">Lagre</button>
                </div>

                <div class="existing-comments">
                    <h4>Eksisterende tiltak og kommentarer:</h4>
                    <div id="existingCommentsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Risks Modal -->
    <div id="importRisksModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Importer risikoer fra analyse</h3>
                <button class="modal-close" onclick="closeImportRisksModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p>Velg en analyse √• importere risikoer fra:</p>

                <div id="analysisListForImport" class="analysis-import-list">
                    <!-- Analyser vil bli lagt til her -->
                </div>

                <div class="import-options" style="margin-top: 20px;">
                    <label>
                        <input type="radio" name="importMode" value="replace" checked>
                        <strong>Erstatt</strong> - Fjern eksisterende risikoer og importer nye
                    </label>
                    <label>
                        <input type="radio" name="importMode" value="append">
                        <strong>Legg til</strong> - Behold eksisterende og legg til importerte risikoer
                    </label>
                </div>

                <div style="margin-top: 20px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeImportRisksModal()">Avbryt</button>
                    <button id="confirmImportBtn" class="btn btn-primary" onclick="confirmImportRisks()">Importer risikoer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/risikobank.js"></script>
    <script src="js/comments.js"></script>
    <script src="js/heatmap.js"></script>
    <script src="js/table.js"></script>
    <script src="js/export-json.js"></script>
    <script src="js/export-pdf.js"></script>
    <script src="js/export-excel.js"></script>
    <script src="js/export-all.js"></script>
    <script>
        let currentAnalysis = null;
        let currentAnalysisId = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Hent analyse-ID fra URL
            const urlParams = new URLSearchParams(window.location.search);
            currentAnalysisId = urlParams.get('id');

            if (!currentAnalysisId) {
                alert('Ingen analyse-ID funnet');
                window.location.href = 'index.html';
                return;
            }

            loadAnalysis();

            // Event listeners
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            document.getElementById('addRiskBtn').addEventListener('click', addNewRisk);
            document.getElementById('importRisksBtn').addEventListener('click', openImportRisksModal);
            document.getElementById('exportJsonBtn').addEventListener('click', exportCurrentAnalysisJSON);
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
            document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
            document.getElementById('exportAllBtn').addEventListener('click', exportAllFormats);

            // Risikobank upload
            document.getElementById('uploadBankBtn').addEventListener('click', () => {
                document.getElementById('bankFileInput').click();
            });
            document.getElementById('bankFileInput').addEventListener('change', handleBankUpload);

            // Metadata auto-save
            document.getElementById('analysisName').addEventListener('blur', saveMetadata);
            document.getElementById('dato').addEventListener('blur', validateAndSaveDate);
            document.getElementById('tjeneste').addEventListener('change', saveMetadata);
            document.getElementById('utfortAv').addEventListener('change', saveMetadata);
            document.getElementById('deltakere').addEventListener('change', saveMetadata);
            document.getElementById('tjenesteeier').addEventListener('change', saveMetadata);
            document.getElementById('beskrivelse').addEventListener('change', saveMetadata);
            document.getElementById('commentsSectionTitle').addEventListener('blur', saveCommentsSectionTitle);
            document.getElementById('customTextTitle').addEventListener('blur', saveCustomTextTitle);
            document.getElementById('customText').addEventListener('change', saveCustomText);
            document.getElementById('acceptanceLevel').addEventListener('change', saveAcceptanceLevel);
            document.getElementById('exportMarkdownBtn').addEventListener('click', exportHighRisksToMarkdown);

            // Initial update of acceptance level preview
            updateAcceptanceLevelPreview();
        });

        function validateAndSaveDate() {
            const datoInput = document.getElementById('dato');
            const dato = datoInput.value.trim();

            // Valider YYYY-MM-DD format
            const datePattern = /^\d{4}-\d{2}-\d{2}$/;
            if (dato && !datePattern.test(dato)) {
                alert('Dato m√• v√¶re i format √Ö√Ö√Ö√Ö-MM-DD (f.eks. 2026-02-26)');
                datoInput.focus();
                return;
            }

            // Sjekk at datoen er gyldig
            if (dato) {
                const parts = dato.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]);
                const day = parseInt(parts[2]);

                if (month < 1 || month > 12 || day < 1 || day > 31) {
                    alert('Ugyldig dato');
                    datoInput.focus();
                    return;
                }
            }

            saveMetadata();
        }

        function saveMetadata() {
            const updates = {
                name: document.getElementById('analysisName').textContent,
                metadata: {
                    dato: document.getElementById('dato').value,
                    tjeneste: document.getElementById('tjeneste').value,
                    utfortAv: document.getElementById('utfortAv').value,
                    deltakere: document.getElementById('deltakere').value,
                    tjenesteeier: document.getElementById('tjenesteeier').value,
                    beskrivelse: document.getElementById('beskrivelse').value
                }
            };

            currentAnalysis = updateAnalysis(currentAnalysisId, updates);
            showSavedIndicator();
        }

        function saveCommentsSectionTitle() {
            const title = document.getElementById('commentsSectionTitle').textContent.trim();
            // Oppdater metadata riktig
            currentAnalysis.metadata.commentsSectionTitle = title;
            currentAnalysis = updateAnalysis(currentAnalysisId, {
                metadata: currentAnalysis.metadata
            });
            showSavedIndicator();
        }

        function saveCustomTextTitle() {
            const title = document.getElementById('customTextTitle').textContent.trim();
            currentAnalysis.metadata.customTextTitle = title;
            currentAnalysis = updateAnalysis(currentAnalysisId, {
                metadata: currentAnalysis.metadata
            });
            showSavedIndicator();
        }

        function saveCustomText() {
            const text = document.getElementById('customText').value;
            currentAnalysis.metadata.customText = text;
            currentAnalysis = updateAnalysis(currentAnalysisId, {
                metadata: currentAnalysis.metadata
            });
            showSavedIndicator();
        }

        function saveAcceptanceLevel() {
            const level = parseInt(document.getElementById('acceptanceLevel').value);
            currentAnalysis.metadata.acceptanceLevel = level;
            currentAnalysis = updateAnalysis(currentAnalysisId, {
                metadata: currentAnalysis.metadata
            });
            updateAcceptanceLevelPreview();
            showSavedIndicator();
        }

        function updateAcceptanceLevelPreview() {
            if (!currentAnalysis || !currentAnalysis.risikoer) return;

            const level = parseInt(document.getElementById('acceptanceLevel').value);
            const risksAboveLevel = currentAnalysis.risikoer.filter(r => r.risikonivaa > level);
            const preview = document.getElementById('acceptanceLevelPreview');
            preview.textContent = `${risksAboveLevel.length} risikoer over niv√• ${level}`;
        }

        function exportHighRisksToMarkdown() {
            if (!currentAnalysis) {
                alert('Ingen analyse √• eksportere');
                return;
            }

            const level = parseInt(document.getElementById('acceptanceLevel').value);
            const risksAboveLevel = currentAnalysis.risikoer.filter(r => r.risikonivaa > level);

            if (risksAboveLevel.length === 0) {
                alert(`Ingen risikoer funnet over akseptanseniv√• ${level}`);
                return;
            }

            let markdown = `# H√∏yrisikorapport - ${currentAnalysis.name}\n\n`;
            markdown += `**Dato:** ${currentAnalysis.metadata.dato || 'Ikke angitt'}\n`;
            markdown += `**Tjeneste/system:** ${currentAnalysis.metadata.tjeneste || 'Ikke angitt'}\n`;
            markdown += `**Utf√∏rt av:** ${currentAnalysis.metadata.utfortAv || 'Ikke angitt'}\n`;
            markdown += `**Akseptanseniv√•:** ${level}\n\n`;
            markdown += `---\n\n`;
            markdown += `## Risikoer over akseptanseniv√•\n\n`;
            markdown += `Totalt **${risksAboveLevel.length}** risikoer over niv√• ${level}.\n\n`;

            // Group by risk level
            const redRisks = risksAboveLevel.filter(r => r.risikonivaa >= 19);
            const orangeRisks = risksAboveLevel.filter(r => r.risikonivaa >= 13 && r.risikonivaa <= 18);
            const yellowRisks = risksAboveLevel.filter(r => r.risikonivaa >= 7 && r.risikonivaa <= 12);

            if (redRisks.length > 0) {
                markdown += `### üî¥ Kritiske risikoer (19-25): ${redRisks.length}\n\n`;
                redRisks.forEach((risk, idx) => {
                    markdown += formatRiskMarkdown(risk, idx + 1);
                });
            }

            if (orangeRisks.length > 0) {
                markdown += `### üü† H√∏ye risikoer (13-18): ${orangeRisks.length}\n\n`;
                orangeRisks.forEach((risk, idx) => {
                    markdown += formatRiskMarkdown(risk, idx + 1);
                });
            }

            if (yellowRisks.length > 0) {
                markdown += `### üü° Medium risikoer (7-12): ${yellowRisks.length}\n\n`;
                yellowRisks.forEach((risk, idx) => {
                    markdown += formatRiskMarkdown(risk, idx + 1);
                });
            }

            markdown += `\n---\n\n`;
            markdown += `*Generert med Risky ${new Date().toISOString().split('T')[0]}*\n`;

            // Download
            const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Risky_H√∏yrisikorapport_${currentAnalysis.metadata.dato || 'ukjent_dato'}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function formatRiskMarkdown(risk, index) {
            let md = `#### ${index}. ${risk.risikoelement} (RN: ${risk.risikonivaa})\n\n`;
            md += `- **S√•rbarhet:** ${risk.saarbarhet || 'Ikke angitt'}\n`;
            md += `- **Konsekvens:** ${risk.konsekvens} | **Sannsynlighet:** ${risk.sannsynlighet}\n`;
            md += `- **KIT:** K=${risk.K}, I=${risk.I}, T=${risk.T}\n`;
            md += `- **Eksisterende beskyttelse:** ${risk.eksisterendeBeskyttelse || 'Ingen'}\n`;
            md += `- **Eksisterende kontroll:** ${risk.eksisterendeKontroll || 'Ingen'}\n`;
            md += `- **Foresl√•tte tiltak:** ${risk.foreslaatteTiltak || 'Ikke angitt'}\n`;

            if (risk.comments && risk.comments.length > 0) {
                md += `- **Kommentarer:**\n`;
                risk.comments.forEach(comment => {
                    md += `  - [${comment.type}] ${comment.text}\n`;
                });
            }

            md += `\n`;
            return md;
        }

        function addNewRisk() {
            const newRisk = {
                id: generateUUID(),
                nr: currentAnalysis.risikoer.length + 1,
                risikoelement: '',
                saarbarhet: '',
                eksisterendeBeskyttelse: '',
                eksisterendeKontroll: '',
                K: 0,
                I: 0,
                T: 0,
                konsekvens: 0,
                sannsynlighet: 0,
                risikonivaa: 0,
                foreslaatteTiltak: ''
            };

            currentAnalysis.risikoer.push(newRisk);
            updateAnalysis(currentAnalysisId, { risikoer: currentAnalysis.risikoer });
            renderRisksTable();
            renderHeatmap();
            renderStatistics();
            renderKITTable();

            // Scroll til og fokuser p√• den nye risikoen
            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-risk-id="${newRisk.id}"]`);
                if (newRow) {
                    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Fokuser p√• f√∏rste input-felt (risikoelement)
                    const firstInput = newRow.querySelector('textarea');
                    if (firstInput) {
                        firstInput.focus();
                    }

                    // Highlight rad i et par sekunder
                    newRow.style.backgroundColor = '#e3f2fd';
                    setTimeout(() => {
                        newRow.style.backgroundColor = '';
                    }, 2000);
                }
            }, 100);
        }

        function exportCurrentAnalysisJSON() {
            const dataStr = JSON.stringify(currentAnalysis, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportName = `Risky_${currentAnalysis.metadata.tjeneste || 'analyse'}_${currentAnalysis.createdDate}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }

        // Import risks from another analysis
        async function openImportRisksModal() {
            const modal = document.getElementById('importRisksModal');
            const listContainer = document.getElementById('analysisListForImport');

            listContainer.innerHTML = '<p style="text-align: center; color: #666;">Laster...</p>';
            modal.style.display = 'flex';

            try {
                // Load baseline analyses
                const baselineFiles = [
                    'baseline-it-tjeneste.json',
                    'baseline-sky.json',
                    'baseline-persondata.json',
                    'baseline-webapp.json',
                    'baseline-database.json',
                    'baseline-mobile.json'
                ];
                const baselinePromises = baselineFiles.map(file =>
                    fetch(`data/baselines/${file}`).then(r => r.json()).catch(() => null)
                );
                const baselines = (await Promise.all(baselinePromises)).filter(b => b !== null);

                // Get user's own analyses
                const allAnalyses = getAnalyses();
                const otherAnalyses = allAnalyses.filter(a => a.id !== currentAnalysis.id);

                // Store all sources for later retrieval
                window._importSources = {
                    baselines: baselines,
                    userAnalyses: otherAnalyses
                };

                // Render analysis list
                listContainer.innerHTML = '';

                // Add baselines section
                if (baselines.length > 0) {
                    const baselinesHeader = document.createElement('h4');
                    baselinesHeader.textContent = 'üìö Forh√•ndsdefinerte maler';
                    baselinesHeader.style.cssText = 'margin: 10px 0; padding: 10px; background: #f0f7ff; border-radius: 4px; color: #2e5f8e;';
                    listContainer.appendChild(baselinesHeader);

                    baselines.forEach((baseline, index) => {
                        const label = createAnalysisImportItem(baseline, `baseline-${baseline.id}`, index === 0);
                        listContainer.appendChild(label);
                    });
                }

                // Add user analyses section
                if (otherAnalyses.length > 0) {
                    const userHeader = document.createElement('h4');
                    userHeader.textContent = 'üìã Mine analyser';
                    userHeader.style.cssText = 'margin: 20px 0 10px 0; padding: 10px; background: #f0f7ff; border-radius: 4px; color: #2e5f8e;';
                    listContainer.appendChild(userHeader);

                    otherAnalyses.forEach((analysis) => {
                        const label = createAnalysisImportItem(analysis, `user-${analysis.id}`, false);
                        listContainer.appendChild(label);
                    });
                }

                // If no options available
                if (baselines.length === 0 && otherAnalyses.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: #666;">Ingen analyser tilgjengelig for import.</p>';
                }

            } catch (error) {
                console.error('Error loading baselines:', error);
                listContainer.innerHTML = '<p style="text-align: center; color: #dc3545;">Kunne ikke laste maler. Pr√∏v igjen.</p>';
            }
        }

        function createAnalysisImportItem(analysis, valueId, isChecked) {
            const label = document.createElement('label');
            label.className = 'analysis-import-item';

            const riskCount = analysis.risikoer ? analysis.risikoer.length : 0;
            const date = analysis.metadata.dato || analysis.createdDate || '';
            const tjeneste = analysis.metadata.tjeneste || analysis.name || 'Uten navn';
            const beskrivelse = analysis.metadata.beskrivelse || '';

            label.innerHTML = `
                <input type="radio" name="selectedAnalysis" value="${valueId}" ${isChecked ? 'checked' : ''}>
                <div class="analysis-import-content">
                    <h4>${tjeneste} <span class="risk-count">${riskCount} risikoer</span></h4>
                    <p><strong>Dato:</strong> ${date}</p>
                    ${analysis.metadata.utfortAv ? `<p><strong>Utf√∏rt av:</strong> ${analysis.metadata.utfortAv}</p>` : ''}
                    ${beskrivelse ? `<p style="font-size: 13px; color: #666; font-style: italic;">${beskrivelse}</p>` : ''}
                </div>
            `;

            return label;
        }

        function confirmImportRisks() {
            const selectedRadio = document.querySelector('input[name="selectedAnalysis"]:checked');
            if (!selectedRadio) {
                alert('Vennligst velg en analyse √• importere fra.');
                return;
            }

            const valueId = selectedRadio.value;
            let sourceAnalysis = null;

            // Check if it's a baseline or user analysis
            if (valueId.startsWith('baseline-')) {
                const baselineId = valueId.replace('baseline-', '');
                sourceAnalysis = window._importSources.baselines.find(b => b.id === baselineId);
            } else if (valueId.startsWith('user-')) {
                const userId = valueId.replace('user-', '');
                sourceAnalysis = window._importSources.userAnalyses.find(a => a.id === userId);
            }

            if (!sourceAnalysis) {
                alert('Kunne ikke finne valgt analyse.');
                return;
            }

            importRisksFromAnalysis(sourceAnalysis);
        }

        function closeImportRisksModal() {
            const modal = document.getElementById('importRisksModal');
            modal.style.display = 'none';
        }

        function importRisksFromAnalysis(sourceAnalysis) {
            try {
                console.log('Import started', sourceAnalysis);

                if (!sourceAnalysis.risikoer || sourceAnalysis.risikoer.length === 0) {
                    alert('Denne analysen har ingen risikoer √• importere.');
                    closeImportRisksModal();
                    return;
                }

                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                const sourceName = sourceAnalysis.metadata.tjeneste || sourceAnalysis.name || 'analysen';
                const riskCount = sourceAnalysis.risikoer.length;

                let message = '';
                if (importMode === 'replace') {
                    message = `Dette vil erstatte alle eksisterende risikoer med ${riskCount} risikoer fra "${sourceName}".\n\nEr du sikker?`;
                } else {
                    message = `Dette vil legge til ${riskCount} risikoer fra "${sourceName}" til de eksisterende.\n\nFortsette?`;
                }

                if (!confirm(message)) {
                    closeImportRisksModal();
                    return;
                }

                // Deep copy the risks to avoid reference issues
                const importedRisks = JSON.parse(JSON.stringify(sourceAnalysis.risikoer));
                console.log('Imported risks:', importedRisks);

                // Ensure currentAnalysis.risikoer is an array
                if (!Array.isArray(currentAnalysis.risikoer)) {
                    currentAnalysis.risikoer = [];
                }

                const previousCount = currentAnalysis.risikoer.length;

                // Generate new IDs and ensure all required fields exist
                importedRisks.forEach((risk, index) => {
                    risk.id = 'risk_' + Date.now() + '_' + index + '_' + Math.random().toString(36).substr(2, 9);

                    // Ensure all required fields exist with proper defaults
                    risk.risikoelement = risk.risikoelement || '';
                    risk.saarbarhet = risk.saarbarhet || '';
                    risk.eksisterendeBeskyttelse = risk.eksisterendeBeskyttelse || '';
                    risk.eksisterendeKontroll = risk.eksisterendeKontroll || '';
                    risk.K = risk.K || 0;
                    risk.I = risk.I || 0;
                    risk.T = risk.T || 0;
                    risk.konsekvens = risk.konsekvens || 0;
                    risk.sannsynlighet = risk.sannsynlighet || 0;
                    risk.risikonivaa = risk.risikonivaa || 0;
                    risk.foreslaatteTiltak = risk.foreslaatteTiltak || '';
                    risk.kommentarer = Array.isArray(risk.kommentarer) ? risk.kommentarer : [];

                    // Set nr field based on mode
                    if (importMode === 'replace') {
                        risk.nr = index + 1;
                    } else {
                        risk.nr = previousCount + index + 1;
                    }
                });

                if (importMode === 'replace') {
                    currentAnalysis.risikoer = importedRisks;
                } else {
                    currentAnalysis.risikoer = [...currentAnalysis.risikoer, ...importedRisks];
                }

                // Renumber ALL risks (in case of replace mode or to fix existing)
                currentAnalysis.risikoer.forEach((risk, index) => {
                    risk.nr = index + 1;
                });

                console.log('New risk count:', currentAnalysis.risikoer.length);
                console.log('First 3 risks nr before save:', currentAnalysis.risikoer.slice(0, 3).map(r => `id:${r.id.slice(0,10)} nr:${r.nr}`));

                // Save to localStorage
                const updatedAnalysis = updateAnalysis(currentAnalysisId, { risikoer: currentAnalysis.risikoer });
                if (updatedAnalysis) {
                    currentAnalysis = updatedAnalysis;
                    console.log('Updated from localStorage, first 3 risks nr:', currentAnalysis.risikoer.slice(0, 3).map(r => `id:${r.id.slice(0,10)} nr:${r.nr}`));
                } else {
                    console.error('updateAnalysis returned null!');
                }

                // Update UI
                renderRisksTable();
                console.log('Table rendered, tbody has', document.getElementById('risksTableBody').children.length, 'rows');

                renderHeatmap();
                renderStatistics();
                console.log('Heatmap and statistics rendered');

                closeImportRisksModal();

                const action = importMode === 'replace' ? 'erstattet med' : 'lagt til';
                alert(`${riskCount} risikoer ${action} fra "${sourceName}"\n\nTotalt n√•: ${currentAnalysis.risikoer.length} risikoer`);
            } catch (error) {
                console.error('Error importing risks:', error);
                alert('Det oppsto en feil ved import: ' + error.message);
                closeImportRisksModal();
            }
        }

        // Bank upload handling
        async function handleBankUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = 'Laster opp...';
            statusEl.style.color = '#666';

            try {
                const bank = await uploadCustomBank(file);
                statusEl.textContent = `‚úì ${bank.navn} lastet opp!`;
                statusEl.style.color = '#28a745';

                // Refresh custom banks list
                renderCustomBanks();

                // Clear file input
                event.target.value = '';

                setTimeout(() => {
                    statusEl.textContent = '';
                }, 3000);
            } catch (err) {
                statusEl.textContent = `‚úó Feil: ${err.message}`;
                statusEl.style.color = '#dc3545';
            }
        }

        function renderCustomBanks() {
            const container = document.getElementById('customBanksList');
            if (!container) return;

            const customBanks = getCustomBanks();

            // Clear container
            container.textContent = '';

            if (customBanks.length === 0) {
                const p = document.createElement('p');
                p.className = 'no-banks';
                p.textContent = 'Ingen egendefinerte risikobanker lastet opp.';
                container.appendChild(p);
                return;
            }

            const h3 = document.createElement('h3');
            h3.textContent = 'Egendefinerte risikobanker:';
            container.appendChild(h3);

            customBanks.forEach(bank => {
                const bankCard = document.createElement('div');
                bankCard.className = 'bank-card';

                const info = document.createElement('div');
                info.className = 'bank-info';

                const name = document.createElement('strong');
                name.textContent = bank.navn;
                info.appendChild(name);

                if (bank.beskrivelse) {
                    const desc = document.createElement('p');
                    desc.textContent = bank.beskrivelse;
                    info.appendChild(desc);
                }

                const meta = document.createElement('small');
                const numKat = bank.kategorier ? bank.kategorier.length : 0;
                const numRisk = bank.kategorier ? bank.kategorier.reduce((sum, k) => sum + (k.risikoer ? k.risikoer.length : 0), 0) : 0;
                meta.textContent = `${numKat} kategorier, ${numRisk} risikoer`;
                info.appendChild(meta);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '√ó';
                deleteBtn.className = 'btn btn-danger btn-icon';
                deleteBtn.title = 'Slett';
                deleteBtn.onclick = async () => {
                    if (confirm(`Er du sikker p√• at du vil slette "${bank.navn}"?`)) {
                        await deleteCustomBank(bank.id);
                        renderCustomBanks();
                    }
                };

                bankCard.appendChild(info);
                bankCard.appendChild(deleteBtn);
                container.appendChild(bankCard);
            });
        }

        // Statistikk og visualisering
        function renderStatistics() {
            if (!currentAnalysis || !currentAnalysis.risikoer || currentAnalysis.risikoer.length === 0) {
                document.getElementById('statTotal').textContent = '0';
                document.getElementById('statRed').textContent = '0';
                document.getElementById('statOrange').textContent = '0';
                document.getElementById('statYellow').textContent = '0';
                document.getElementById('statGreen').textContent = '0';
                document.getElementById('statAvgRisk').textContent = '0.0';
                document.getElementById('statRedPercent').textContent = '0%';
                document.getElementById('statOrangePercent').textContent = '0%';
                document.getElementById('statYellowPercent').textContent = '0%';
                document.getElementById('statGreenPercent').textContent = '0%';
                return;
            }

            const risks = currentAnalysis.risikoer;
            const total = risks.length;

            // Kategoriser risikoer etter niv√•
            let green = 0, yellow = 0, orange = 0, red = 0;
            let sumRiskLevel = 0;

            risks.forEach(risk => {
                const rn = risk.risikonivaa;
                sumRiskLevel += rn;

                if (rn >= 1 && rn <= 6) green++;
                else if (rn >= 7 && rn <= 12) yellow++;
                else if (rn >= 13 && rn <= 18) orange++;
                else if (rn >= 19 && rn <= 25) red++;
            });

            const avgRisk = total > 0 ? (sumRiskLevel / total).toFixed(1) : '0.0';

            // Oppdater stat cards
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statRed').textContent = red;
            document.getElementById('statOrange').textContent = orange;
            document.getElementById('statYellow').textContent = yellow;
            document.getElementById('statGreen').textContent = green;
            document.getElementById('statAvgRisk').textContent = avgRisk;

            document.getElementById('statRedPercent').textContent = total > 0 ? `${Math.round(red/total*100)}%` : '0%';
            document.getElementById('statOrangePercent').textContent = total > 0 ? `${Math.round(orange/total*100)}%` : '0%';
            document.getElementById('statYellowPercent').textContent = total > 0 ? `${Math.round(yellow/total*100)}%` : '0%';
            document.getElementById('statGreenPercent').textContent = total > 0 ? `${Math.round(green/total*100)}%` : '0%';

            // Render charts
            renderConsequenceChart(risks);
            renderProbabilityChart(risks);
            renderKITChart(risks);

            // Update acceptance level preview
            updateAcceptanceLevelPreview();
        }

        function renderConsequenceChart(risks) {
            const canvas = document.getElementById('consequenceChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Count distribution
            const distribution = [0, 0, 0, 0, 0];
            risks.forEach(r => {
                if (r.konsekvens >= 1 && r.konsekvens <= 5) {
                    distribution[r.konsekvens - 1]++;
                }
            });

            const maxCount = Math.max(...distribution, 1);
            const barWidth = 50;
            const gap = 10;
            const chartHeight = 150;
            const startX = 20;
            const startY = 180;

            // Draw bars
            distribution.forEach((count, i) => {
                const barHeight = (count / maxCount) * chartHeight;
                const x = startX + i * (barWidth + gap);
                const y = startY - barHeight;

                ctx.fillStyle = '#4a90e2';
                ctx.fillRect(x, y, barWidth, barHeight);

                // Draw count
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(count, x + barWidth/2, y - 5);

                // Draw label
                ctx.font = '12px Arial';
                ctx.fillText((i+1).toString(), x + barWidth/2, startY + 15);
            });

            // Draw axis label
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Konsekvens (1-5)', canvas.width / 2, canvas.height - 5);
        }

        function renderProbabilityChart(risks) {
            const canvas = document.getElementById('probabilityChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Count distribution
            const distribution = [0, 0, 0, 0, 0];
            risks.forEach(r => {
                if (r.sannsynlighet >= 1 && r.sannsynlighet <= 5) {
                    distribution[r.sannsynlighet - 1]++;
                }
            });

            const maxCount = Math.max(...distribution, 1);
            const barWidth = 50;
            const gap = 10;
            const chartHeight = 150;
            const startX = 20;
            const startY = 180;

            // Draw bars
            distribution.forEach((count, i) => {
                const barHeight = (count / maxCount) * chartHeight;
                const x = startX + i * (barWidth + gap);
                const y = startY - barHeight;

                ctx.fillStyle = '#e94e77';
                ctx.fillRect(x, y, barWidth, barHeight);

                // Draw count
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(count, x + barWidth/2, y - 5);

                // Draw label
                ctx.font = '12px Arial';
                ctx.fillText((i+1).toString(), x + barWidth/2, startY + 15);
            });

            // Draw axis label
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Sannsynlighet (1-5)', canvas.width / 2, canvas.height - 5);
        }

        function renderKITChart(risks) {
            const canvas = document.getElementById('kitChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Count average K, I, T
            let sumK = 0, sumI = 0, sumT = 0;
            risks.forEach(r => {
                sumK += r.K || 0;
                sumI += r.I || 0;
                sumT += r.T || 0;
            });

            const avgK = risks.length > 0 ? sumK / risks.length : 0;
            const avgI = risks.length > 0 ? sumI / risks.length : 0;
            const avgT = risks.length > 0 ? sumT / risks.length : 0;

            const data = [
                { label: 'K', value: avgK, color: '#28a745' },
                { label: 'I', value: avgI, color: '#ffc107' },
                { label: 'T', value: avgT, color: '#dc3545' }
            ];

            const barWidth = 70;
            const gap = 20;
            const chartHeight = 150;
            const startX = 40;
            const startY = 180;
            const maxValue = 5;

            // Draw bars
            data.forEach((item, i) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = startX + i * (barWidth + gap);
                const y = startY - barHeight;

                ctx.fillStyle = item.color;
                ctx.fillRect(x, y, barWidth, barHeight);

                // Draw value
                ctx.fillStyle = '#000';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.value.toFixed(1), x + barWidth/2, y - 5);

                // Draw label
                ctx.font = '12px Arial';
                ctx.fillText(item.label, x + barWidth/2, startY + 15);
            });

            // Draw axis label
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Gjennomsnittlig KIT-verdi', canvas.width / 2, canvas.height - 5);
        }

        // Override loadAnalysis to include custom banks rendering
        async function loadAnalysis() {
            // Last risikobank f√∏rst
            await loadRisikobank();

            // Setup modals
            setupRisikobankModal();
            setupCommentModal();

            currentAnalysis = getAnalysisById(currentAnalysisId);
            if (!currentAnalysis) {
                alert('Analyse ikke funnet');
                window.location.href = 'index.html';
                return;
            }

            // Populer metadata
            document.getElementById('analysisName').textContent = currentAnalysis.name;
            document.getElementById('dato').value = currentAnalysis.metadata.dato || '';
            document.getElementById('tjeneste').value = currentAnalysis.metadata.tjeneste || '';
            document.getElementById('utfortAv').value = currentAnalysis.metadata.utfortAv || '';
            document.getElementById('deltakere').value = currentAnalysis.metadata.deltakere || '';
            document.getElementById('tjenesteeier').value = currentAnalysis.metadata.tjenesteeier || '';
            document.getElementById('beskrivelse').value = currentAnalysis.metadata.beskrivelse || '';
            document.getElementById('commentsSectionTitle').textContent =
                currentAnalysis.metadata.commentsSectionTitle || 'TILTAK OG KOMMENTARER';
            document.getElementById('customTextTitle').textContent =
                currentAnalysis.metadata.customTextTitle || 'TILLEGGSINFORMASJON';
            document.getElementById('customText').value =
                currentAnalysis.metadata.customText || '';
            document.getElementById('acceptanceLevel').value =
                currentAnalysis.metadata.acceptanceLevel || 12;

            // Populer risikoer
            renderRisksTable();
            renderHeatmap();
            renderStatistics();
            renderKITTable();
            renderComments();

            // Aktiver heatmap klikk
            setupHeatmapClick();

            // Render custom banks
            renderCustomBanks();
        }
    </script>
</body>
</html>
