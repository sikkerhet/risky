<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risky</title>
    <link rel="stylesheet" href="css/main.css">

    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- ZIP Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>RISKY</h1>
            <p class="subtitle">Risiko- og s√•rbarhetsanalyse</p>
        </header>

        <div class="actions">
            <button id="newAnalysisBtn" class="btn btn-primary">+ Ny analyse</button>
            <button id="importJsonBtn" class="btn btn-secondary">üìÅ Importer JSON</button>
            <button id="exportAllBtn" class="btn btn-secondary">üíæ Eksporter alle</button>
            <button id="helpBtn" class="btn btn-secondary">‚ùì Hjelp</button>
            <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
        </div>

        <section class="analyses-section">
            <h2>MINE ANALYSER</h2>
            <div id="analysesList" class="analyses-list">
                <!-- Analyser vil bli lagt til her dynamisk -->
            </div>
            <div id="emptyState" class="empty-state">
                <p>Ingen analyser enn√•. Klikk "Ny analyse" for √• komme i gang.</p>
            </div>
        </section>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Initialiser startskjerm
        document.addEventListener('DOMContentLoaded', () => {
            loadAnalysesList();

            document.getElementById('newAnalysisBtn').addEventListener('click', createNewAnalysis);
            document.getElementById('importJsonBtn').addEventListener('click', () => {
                document.getElementById('jsonFileInput').click();
            });
            document.getElementById('jsonFileInput').addEventListener('change', importJSON);
            document.getElementById('exportAllBtn').addEventListener('click', exportAllAnalyses);
            document.getElementById('helpBtn').addEventListener('click', () => {
                window.open('help.html', '_blank');
            });
        });

        function loadAnalysesList() {
            const analyses = getAnalyses();
            const listElement = document.getElementById('analysesList');
            const emptyState = document.getElementById('emptyState');

            if (analyses.length === 0) {
                listElement.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            listElement.style.display = 'block';
            emptyState.style.display = 'none';
            listElement.textContent = '';

            analyses
                .sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified))
                .forEach(analysis => {
                    const card = createAnalysisCard(analysis);
                    listElement.appendChild(card);
                });
        }

        function createAnalysisCard(analysis) {
            const card = document.createElement('div');
            card.className = 'analysis-card';

            const title = document.createElement('h3');
            title.textContent = analysis.name;
            card.appendChild(title);

            const meta = document.createElement('div');
            meta.className = 'analysis-meta';
            const created = document.createElement('span');
            created.textContent = `Opprettet: ${formatDate(analysis.createdDate)}`;
            const modified = document.createElement('span');
            modified.textContent = `Sist endret: ${formatDate(analysis.lastModified)}`;
            meta.appendChild(created);
            meta.appendChild(modified);
            card.appendChild(meta);

            const info = document.createElement('div');
            info.className = 'analysis-info';
            const riskCount = document.createElement('span');
            riskCount.textContent = `${analysis.risikoer.length} risikoer`;
            info.appendChild(riskCount);
            if (analysis.metadata.tjeneste) {
                const service = document.createElement('span');
                service.textContent = `Tjeneste: ${analysis.metadata.tjeneste}`;
                info.appendChild(service);
            }
            card.appendChild(info);

            const actions = document.createElement('div');
            actions.className = 'analysis-actions';

            const openBtn = document.createElement('button');
            openBtn.className = 'btn btn-primary';
            openBtn.textContent = '√Öpne';
            openBtn.onclick = () => openAnalysis(analysis.id);
            actions.appendChild(openBtn);

            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-secondary';
            exportBtn.textContent = 'Eksporter JSON';
            exportBtn.onclick = () => exportAnalysis(analysis.id);
            actions.appendChild(exportBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.textContent = 'Slett';
            deleteBtn.onclick = () => deleteAnalysis(analysis.id);
            actions.appendChild(deleteBtn);

            card.appendChild(actions);

            return card;
        }

        function createNewAnalysis() {
            const id = generateUUID();
            const now = new Date().toISOString();
            const newAnalysis = {
                id: id,
                name: 'Ny ROS-analyse',
                createdDate: now.split('T')[0],
                lastModified: now,
                metadata: {
                    dato: now.split('T')[0],
                    tjeneste: '',
                    utfortAv: '',
                    deltakere: '',
                    tjenesteeier: '',
                    beskrivelse: ''
                },
                risikoer: []
            };

            const analyses = getAnalyses();
            analyses.push(newAnalysis);
            saveAnalyses(analyses);

            window.location.href = `editor.html?id=${id}`;
        }

        function openAnalysis(id) {
            window.location.href = `editor.html?id=${id}`;
        }

        function exportAnalysis(id) {
            const analyses = getAnalyses();
            const analysis = analyses.find(a => a.id === id);
            if (!analysis) return;

            const dataStr = JSON.stringify(analysis, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportName = `Risky_${analysis.metadata.tjeneste || 'analyse'}_${analysis.createdDate}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }

        // Helper: Generate PDF blob for an analysis
        async function generatePDFForAnalysis(analysis) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a4');

            function safeText(value) {
                if (value === null || value === undefined) return '';
                return String(value).replace(/[\u0000-\u001F\u007F-\u009F]/g, '');
            }

            // Metadata
            doc.setFontSize(20);
            doc.text('Risky', 20, 20);

            doc.setFontSize(12);
            let yPos = 35;
            const metadata = analysis.metadata;

            if (metadata.tjeneste) {
                doc.text(`Tjeneste/system: ${safeText(metadata.tjeneste)}`, 20, yPos);
                yPos += 7;
            }
            if (metadata.dato) {
                doc.text(`Dato: ${safeText(metadata.dato)}`, 20, yPos);
                yPos += 7;
            }
            if (metadata.utfortAv) {
                doc.text(`Utf√∏rt av: ${safeText(metadata.utfortAv)}`, 20, yPos);
                yPos += 7;
            }
            if (metadata.deltakere) {
                doc.text(`Deltakere: ${safeText(metadata.deltakere)}`, 20, yPos);
                yPos += 7;
            }
            if (metadata.tjenesteeier) {
                doc.text(`Tjenesteeier: ${safeText(metadata.tjenesteeier)}`, 20, yPos);
                yPos += 7;
            }
            if (metadata.beskrivelse) {
                const beskrivelse = safeText(metadata.beskrivelse);
                const splitBeskrivelse = doc.splitTextToSize(beskrivelse, 250);
                doc.text(`Beskrivelse: ${splitBeskrivelse[0]}`, 20, yPos);
                yPos += 7;
                for (let i = 1; i < splitBeskrivelse.length; i++) {
                    doc.text(splitBeskrivelse[i], 20, yPos);
                    yPos += 7;
                }
            }

            yPos += 5;

            // Risikotabell
            const tableData = analysis.risikoer.map((risk, index) => [
                (index + 1).toString(),
                safeText(risk.risikoelement),
                safeText(risk.saarbarhet),
                safeText(risk.eksisterendeBeskyttelse),
                safeText(risk.eksisterendeKontroll),
                safeText(risk.K),
                safeText(risk.I),
                safeText(risk.T),
                safeText(risk.konsekvens),
                safeText(risk.sannsynlighet),
                safeText(risk.risikonivaa),
                safeText(risk.foreslaatteTiltak)
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['Nr', 'Risikoelement', 'S√•rbarhet', 'Beskyttelse', 'Kontroll', 'K', 'I', 'T', 'K*', 'S*', 'RN*', 'Tiltak']],
                body: tableData,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [46, 95, 142], textColor: 255 },
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 35 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 30 },
                    4: { cellWidth: 30 },
                    5: { cellWidth: 8 },
                    6: { cellWidth: 8 },
                    7: { cellWidth: 8 },
                    8: { cellWidth: 10 },
                    9: { cellWidth: 10 },
                    10: { cellWidth: 10 },
                    11: { cellWidth: 35 }
                },
                margin: { left: 10, right: 10 },
                rowPageBreak: 'avoid'
            });

            // Kommentarer
            try {
                const risksWithComments = analysis.risikoer.filter(r =>
                    r.kommentarer && r.kommentarer.some(c => !c.resolved)
                );

                if (risksWithComments.length > 0) {
                    doc.addPage();
                    doc.setFontSize(16);
                    doc.text('Tiltak og kommentarer', 20, 20);

                    let yPosition = 35;
                    risksWithComments.forEach((risk) => {
                        const visibleComments = risk.kommentarer.filter(c => !c.resolved);
                        if (visibleComments.length === 0) return;

                        const riskIndex = analysis.risikoer.indexOf(risk) + 1;

                        if (yPosition > 180) {
                            doc.addPage();
                            yPosition = 20;
                        }

                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(`Risiko ${riskIndex}: ${safeText(risk.risikoelement)}`, 20, yPosition);
                        yPosition += 7;

                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);

                        visibleComments.forEach(comment => {
                            if (yPosition > 185) {
                                doc.addPage();
                                yPosition = 20;
                            }

                            const timestamp = comment.timestamp ? new Date(comment.timestamp).toLocaleString('no-NO') : '';
                            const commentText = `‚Ä¢ [${timestamp}] ${safeText(comment.text)}`;
                            const splitText = doc.splitTextToSize(commentText, 250);

                            splitText.forEach(line => {
                                if (yPosition > 185) {
                                    doc.addPage();
                                    yPosition = 20;
                                }
                                doc.text(line, 25, yPosition);
                                yPosition += 6;
                            });
                        });

                        yPosition += 5;
                    });
                }
            } catch (e) {
                console.error('Error in comments section:', e);
            }

            // Sidetall
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(100, 100, 100);
                doc.text(`Side ${i} av ${totalPages}`, 148, 200, { align: 'center' });
            }

            return doc.output('blob');
        }

        // Helper: Generate Excel blob for an analysis
        function generateExcelForAnalysis(analysis) {
            function safeText(value) {
                if (value === null || value === undefined) return '';
                return String(value);
            }

            const wb = XLSX.utils.book_new();

            // Metadata-ark
            const metadataData = [
                ['Risky - Risikoanalyse'],
                [''],
                ['Informasjon', 'Verdi'],
                ['Tjeneste/system', safeText(analysis.metadata.tjeneste)],
                ['Dato', safeText(analysis.metadata.dato)],
                ['Utf√∏rt av', safeText(analysis.metadata.utfortAv)],
                ['Deltakere', safeText(analysis.metadata.deltakere)],
                ['Tjenesteeier', safeText(analysis.metadata.tjenesteeier)],
                ['Beskrivelse', safeText(analysis.metadata.beskrivelse)],
                [''],
                ['Opprettet', safeText(analysis.createdDate)],
                ['Sist endret', safeText(analysis.lastModified)]
            ];

            const wsMetadata = XLSX.utils.aoa_to_sheet(metadataData);
            if (!wsMetadata['!cols']) wsMetadata['!cols'] = [];
            wsMetadata['!cols'][0] = { wch: 20 };
            wsMetadata['!cols'][1] = { wch: 60 };
            XLSX.utils.book_append_sheet(wb, wsMetadata, 'Metadata');

            // Risikoer-ark
            const risksData = [
                ['Nr', 'Risikoelement', 'S√•rbarhet/svakhet', 'Eksisterende beskyttelse', 'Eksisterende kontroll',
                 'K', 'I', 'T', 'K*', 'S*', 'RN*', 'Foresl√•tte tiltak']
            ];

            analysis.risikoer.forEach((risk, index) => {
                risksData.push([
                    index + 1,
                    safeText(risk.risikoelement),
                    safeText(risk.saarbarhet),
                    safeText(risk.eksisterendeBeskyttelse),
                    safeText(risk.eksisterendeKontroll),
                    safeText(risk.K),
                    safeText(risk.I),
                    safeText(risk.T),
                    safeText(risk.konsekvens),
                    safeText(risk.sannsynlighet),
                    safeText(risk.risikonivaa),
                    safeText(risk.foreslaatteTiltak)
                ]);
            });

            const wsRisks = XLSX.utils.aoa_to_sheet(risksData);
            if (!wsRisks['!cols']) wsRisks['!cols'] = [];
            wsRisks['!cols'][0] = { wch: 5 };
            wsRisks['!cols'][1] = { wch: 25 };
            wsRisks['!cols'][2] = { wch: 30 };
            wsRisks['!cols'][3] = { wch: 25 };
            wsRisks['!cols'][4] = { wch: 25 };
            wsRisks['!cols'][5] = { wch: 4 };
            wsRisks['!cols'][6] = { wch: 4 };
            wsRisks['!cols'][7] = { wch: 4 };
            wsRisks['!cols'][8] = { wch: 4 };
            wsRisks['!cols'][9] = { wch: 4 };
            wsRisks['!cols'][10] = { wch: 5 };
            wsRisks['!cols'][11] = { wch: 30 };

            XLSX.utils.book_append_sheet(wb, wsRisks, 'Risikoer');

            // Kommentarer-ark
            if (analysis.risikoer && analysis.risikoer.some(r => r.kommentarer && r.kommentarer.length > 0)) {
                try {
                    const commentsData = [
                        ['Tiltak og kommentarer'],
                        [''],
                        ['Risiko Nr', 'Risikoelement', 'Kommentar']
                    ];

                    let hasAnyVisibleComments = false;

                    analysis.risikoer.forEach((risk, index) => {
                        if (risk.kommentarer && risk.kommentarer.length > 0) {
                            const visibleComments = risk.kommentarer.filter(c => !c.resolved);
                            if (visibleComments.length > 0) {
                                hasAnyVisibleComments = true;
                                visibleComments.forEach(comment => {
                                    const timestamp = comment.timestamp ? new Date(comment.timestamp).toLocaleString('no-NO') : '';
                                    const commentText = `[${timestamp}] ${safeText(comment.text)}`;
                                    commentsData.push([
                                        index + 1,
                                        safeText(risk.risikoelement),
                                        commentText
                                    ]);
                                });
                                commentsData.push(['---']);
                                commentsData.push(['']);
                            }
                        }
                    });

                    if (hasAnyVisibleComments) {
                        const wsComments = XLSX.utils.aoa_to_sheet(commentsData);
                        if (!wsComments['!cols']) wsComments['!cols'] = [];
                        wsComments['!cols'][0] = { wch: 20 };
                        wsComments['!cols'][1] = { wch: 50 };
                        wsComments['!cols'][2] = { wch: 60 };
                        XLSX.utils.book_append_sheet(wb, wsComments, 'Tiltak og kommentarer');
                    }
                } catch (e) {
                    console.error('Error creating comments sheet:', e);
                }
            }

            const wbout = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
            return new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        }

        async function exportAllAnalyses() {
            const analyses = getAnalyses();
            if (analyses.length === 0) {
                alert('Ingen analyser √• eksportere');
                return;
            }

            const btn = document.getElementById('exportAllBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Genererer alle...';
            btn.disabled = true;

            try {
                const zip = new JSZip();

                for (let i = 0; i < analyses.length; i++) {
                    const analysis = analyses[i];
                    const folderName = `${i + 1}_${sanitizeFolderName(analysis.metadata.tjeneste || analysis.name || 'analyse')}`;
                    const folder = zip.folder(folderName);

                    // Generer filer for denne analysen
                    const pdfBlob = await generatePDFForAnalysis(analysis);
                    const excelBlob = generateExcelForAnalysis(analysis);
                    const jsonBlob = new Blob([JSON.stringify(analysis, null, 2)], { type: 'application/json' });

                    const baseName = sanitizeFileName(analysis.metadata.tjeneste || 'analyse');
                    const dato = analysis.createdDate || 'ukjent';

                    folder.file(`Risky_${baseName}_${dato}.pdf`, pdfBlob);
                    folder.file(`Risky_${baseName}_${dato}.xlsx`, excelBlob);
                    folder.file(`Risky_${baseName}_${dato}.json`, jsonBlob);
                }

                // Generer og last ned ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const zipFilename = `Risky_alle_analyser_${new Date().toISOString().split('T')[0]}.zip`;

                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = zipFilename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

                btn.textContent = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error('Feil ved eksport:', error);
                alert('Det oppsto en feil ved eksport. Se konsollen for detaljer.');
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function sanitizeFolderName(name) {
            return name.replace(/[^a-zA-Z0-9√¶√∏√•√Ü√ò√Ö_-]/g, '_').substring(0, 50);
        }

        function sanitizeFileName(name) {
            return name.replace(/[^a-zA-Z0-9√¶√∏√•√Ü√ò√Ö_-]/g, '_');
        }

        function deleteAnalysis(id) {
            if (!confirm('Er du sikker p√• at du vil slette denne analysen?')) return;

            const analyses = getAnalyses();
            const filtered = analyses.filter(a => a.id !== id);
            saveAnalyses(filtered);
            loadAnalysesList();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    const analyses = getAnalyses();

                    // Sjekk om det er √©n analyse eller flere
                    if (Array.isArray(imported)) {
                        // Flere analyser
                        imported.forEach(analysis => {
                            if (validateAnalysis(analysis)) {
                                const existing = analyses.findIndex(a => a.id === analysis.id);
                                if (existing >= 0) {
                                    if (confirm(`Analyse "${analysis.name}" finnes allerede. Overskrive?`)) {
                                        analyses[existing] = analysis;
                                    }
                                } else {
                                    analyses.push(analysis);
                                }
                            }
                        });
                    } else {
                        // √ân analyse
                        if (validateAnalysis(imported)) {
                            const existing = analyses.findIndex(a => a.id === imported.id);
                            if (existing >= 0) {
                                if (confirm(`Analyse "${imported.name}" finnes allerede. Overskrive?`)) {
                                    analyses[existing] = imported;
                                }
                            } else {
                                analyses.push(imported);
                            }
                        } else {
                            alert('Ugyldig analyse-fil');
                            return;
                        }
                    }

                    saveAnalyses(analyses);
                    loadAnalysesList();
                    alert('Import fullf√∏rt!');
                } catch (err) {
                    alert('Feil ved import: ' + err.message);
                }
            };
            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        function validateAnalysis(analysis) {
            return analysis &&
                   analysis.id &&
                   analysis.name &&
                   analysis.metadata &&
                   Array.isArray(analysis.risikoer);
        }

        function formatDate(dateStr) {
            // Returner YYYY-MM-DD format direkte
            if (!dateStr) return '';
            // Hvis dateStr er ISO string, ta kun dato-delen
            return dateStr.split('T')[0];
        }
    </script>
</body>
</html>
